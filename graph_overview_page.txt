<template>
  <page-rest
    id="dashboard"
    title="Overview" >
    <template
      v-if="!$q.platform.is.mobile">
      <div class="row gutter-xs">
        <div class="col-12">
          <div class="wrapper bg-white panel-def">
            <div class="header">
              <span>Overview</span>
            </div>
            <div class="row">
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-group" />
                </span>
                <span class="numbers">{{ stats.students }}</span>
                <span class="text">Active Students</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-multiple" />
                </span>
                <span class="numbers">{{ stats.employees }}</span>
                <span class="text">Employees</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-multiple-outline" />
                </span>
                <span class="numbers">{{ stats.parents }}</span>
                <span class="text">Parents</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-school" />
                </span>
                <span class="numbers">{{ stats.classArms }}</span>
                <span class="text">Classrooms</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div
        class="row q-mt-sm gutter-xs"
        style="height: 60vh">
        <div class="col-md-4 col-xs-12">
          <div
            class="wrapper bg-white panel-def"
            style="min-height: 100%;">
            <div class="header">
              <span>Fees Collection</span>
            </div>
            <div class="stat-display">
              <span class="per">{{ deepValue(stats, 'fees.collection_ratio', 0) * 100 }} %</span>
              <span class="fo">COLLECTION RATE</span>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Expected Amount</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_expected', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Amount Collected</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_paid', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Receivables</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_remaining', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l text-center">
                <router-link to="/fee/slips">
                  <q-btn
                    flat
                    label="View fee slips"
                    color="primary"/>
                </router-link>
              </div>
            </div>
          </div>
        </div>
        <div class="col-xs-12 col-md-8">
          <div
            class="wrapper bg-white panel-def"
            style="min-height: 100%;">
            <div class="header">
              <span>Latest Transactions</span>
            </div>
            <page-table
              :columns="transactionColumns"
              :data="stats.transactions"
              :visible-columns="['full_name', 'amount_payable', 'paid_with']"
              selection="none"
              hide-bottom />
          </div>
        </div>
      </div>
    </template>
    <template
      v-else>
      <div class="row gutter-xs">
        <div class="col-12">
          <div class="wrapper bg-white panel-def">
            <div class="header">
              <span>Overview</span>
            </div>
            <div class="row">
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-group" />
                </span>
                <span class="numbers">{{ stats.students }}</span>
                <span class="text">Active Students</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-multiple" />
                </span>
                <span class="numbers">{{ stats.employees }}</span>
                <span class="text">Employees</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-account-multiple-outline" />
                </span>
                <span class="numbers">{{ stats.parents }}</span>
                <span class="text">Parents</span>
              </div>
              <div class="col-md-3 col-xs-6 text-center stats">
                <span class="icons"> <q-icon name="mdi-school" />
                </span>
                <span class="numbers">{{ stats.classArms }}</span>
                <span class="text">Classrooms</span>
              </div>
            </div>
          </div>
        </div>
      </div>
        <div class="col-md-4 col-xs-12 mobile-overview">
          <div
            class="wrapper bg-white panel-def"
            style="min-height: 100%;">
            <div class="header">
              <span>Fees Collection</span>
            </div>
            <div class="stat-display">
              <div class="sc-gauge">
                  <div class="sc-background">
                    <div
                      class="sc-percentage"
                      :style="`transform:rotate(${((deepValue(stats, 'fees.collection_ratio', 0) * 100) *180)/100}deg)`"></div>
                    <div class="sc-mask"></div>
                    <span class="sc-value">{{ deepValue(stats, 'fees.collection_ratio', 0) * 100 }}%</span>
                  </div>
                  <span class="sc-min">0</span>
                  <span class="sc-max">100</span>
              </div>
              <!-- <span class="per">{{ deepValue(stats, 'fees.collection_ratio', 0) * 100 }} %</span> -->
              <span class="q-display-1">COLLECTION RATE</span>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Expected Amount</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_expected', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Amount Collected</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_paid', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l">
                <span>Receivables</span>
                <span class="float-right bold">{{ deepValue(stats, 'fees.total_amount_remaining', 0) | currency('? ') }}</span>
              </div>
            </div>
            <div class="list-display">
              <div class="container-l text-center">
                <router-link to="/fee/slips">
                  <q-btn
                    flat
                    label="View fee slips"
                    color="primary"/>
                </router-link>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 col-xs-12 mobile-overview">
          <div
            class="wrapper bg-white panel-def"
            style="min-height: 100%;">
            <div class="header">
              <span>Latest Transactions</span>
            </div>
            <div >
            <q-list
              v-for="(trans, index) in stats.transactions"
              :key="`${index}-transactions`"
              link
              multiline
              no-border>
              <q-item >
                <q-item-side>
                  <q-item-tile
                    label
                    class="bold">
                    {{ capitalize(deepValue(trans, 'user.last_name', '') +' '+ deepValue(trans, 'user.first_name', ''))}}
                  </q-item-tile>
                  <q-item-tile sublabel>
                    {{ deepValue(trans, 'user.currentClassArm.name', '')}}
                  </q-item-tile>
                </q-item-side>
                <q-item-main />
                  <q-item-side class="text-center">
                    <q-item-tile label>
                      {{trans.amount_payable | currency('? ')}}
                    </q-item-tile>
                    <q-item-tile sublabel>
                      {{trans.created_at }}
                    </q-item-tile>
                  </q-item-side>
                <q-item-separator />
              </q-item>
            </q-list>
            </div>
          </div>
        </div>

    </template>
  </page-rest>
</template>

<script>
import { columns } from '../transaction/helpers.js'

export default {
  name: 'DashBoardPage',
  data () {
    return {
      stats: {
        transactions: []
      }
    }
  },
  computed: {
    transactionColumns () {
      return columns(this, true)
    },
    totalPercent () {
      return
    }
  },
  created () {
    this.$http.get('/schools/current/stats')
      .then(stats => {
        this.$set(this, 'stats', stats)
      })
      .catch(this.processErrors)
  }
}
</script>

<style>

  .icons{
    color: #199eb5!important;
    font-size: 4rem;
  }
  .dashboard .q-item-sublabel {
    color: #757575;
    font-size: 70%!important;
    margin-top: 0.2rem;
 }

 .dashboard .q-item-side {
    min-width: 30px!important;
}

 .stat-display{
  margin: 0 auto;
  text-align: center;
  padding: 3rem 6rem;
}

 .stat-display .per{
  font-size: 3rem;
  font-weight: bold;
  color: #199eb5!important;
 }
 .stat-display .fo{
  font-size: 0.8rem;
  display: block;
  margin-top: 0.7rem;
}

.stat-display .amountz{
  color: green;
  display: block;
  margin-top: 1.3rem;
  margin-bottom: 1.5rem;
  font-weight: bold;
  font-size: 1.4rem;
}

.list-display{
  border-top: 1px solid #eee;
}

.list-display .container-l{
  padding: 1.5rem 1rem;
}
.mobile-overview .stat-display { padding: 1rem 1rem;}
.sc-gauge  { width:200px; height:140px; margin: auto; }
.sc-background { position:relative; height:100px; margin-bottom:10px; background-color:#dae7f5; border-radius:150px 150px 0 0; overflow:hidden; text-align:center; }
.sc-mask { position:absolute; top:20px; right:20px; left:20px; height:80px; background-color:#199eb5; border-radius:150px 150px 0 0 }
.sc-percentage { position:absolute; top:100px; left:-200%; width:400%; height:400%; margin-left:100px; background-color:#0a5773; transform-origin:top center;}
/* .sc-percentage { transform:rotate(158deg);  } */
.sc-min { float:left; }
.sc-max { float:right; }
/* background-color: #199eb5 */
.sc-value { position:absolute; top:37%; left:0; width:100%;  font-size:48px; font-weight:none; color: white; }
</style>
